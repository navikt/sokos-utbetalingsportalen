---
import Layout from "@layouts/Layout.astro";
import NoAccess from "@pages/NoAccess.astro";
import { hasAccessToApp } from "@utils/accessControl";
import { getMicrofrontendConfig } from "src/microfrontend";
import Microfrontend from "./Microfrontend";
import { logger } from "@utils/logger";
import { getServerSideEnvironment } from "@utils/server/environment";

interface Props {
  appName: string;
}

const { appName } = Astro.props;
const appConfig = getMicrofrontendConfig(appName);

const hasAccess = hasAccessToApp(Astro.locals.userInfo.groups, appConfig);

export function fetchMicrofrontendBundleUrl(request: Request, appName: string) {
  const requestUrl = new URL(request.url);
  const hostname = requestUrl.hostname;

  if (getServerSideEnvironment() === "local") {
    return "http://localhost:3000/bundle.js";
  }
  return `https://${hostname}/${appName}/bundle.js`;
}

const test = Astro.request.url;
logger.info(test);
---

<Layout title={appConfig.title}>
  <div>
    {
      hasAccess ? (
        <Microfrontend
          url={fetchMicrofrontendBundleUrl(Astro.request, appConfig.naisAppName)}
          client:only="react"
        />
      ) : (
        <NoAccess />
      )
    }
  </div>
</Layout>
