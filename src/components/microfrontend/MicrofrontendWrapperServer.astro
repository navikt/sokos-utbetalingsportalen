---
import Layout from "@layouts/Layout.astro";
import { Alert } from "@navikt/ds-react";
import { logger } from "@utils/logger";
import { getOboToken } from "@utils/server/token";

type Props = {
  appTitle: string;
  appUrl?: string;
  appAudience?: string;
};

const { appTitle, appUrl, appAudience } = Astro.props;
let html = null;
let error = null;

if (!appUrl || !appAudience) {
  logger.error(
    "Missing required microfrontend parameters, appIngressUrl or appAudience"
  );
  error =
    "Missing required microfrontend parameters, appIngressUrl or appAudience";
} else {
  try {
    const oboToken = await getOboToken(Astro.locals.token, appAudience);

    const response = await fetch(appUrl, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${oboToken}`,
      },
    });

    if (!response.ok) {
      logger.info(
        {
          url: response.url,
          status: response.status,
          statusText: response.statusText,
        },
        "Failed to fetch html"
      );
      error = `Failed to fetch html content from ${response.url} with status: ${response.status} ${response.statusText}`;
    } else {
      html = await response.text();
    }
  } catch (e) {
    logger.error(`Fetch from ${appUrl} failed: ${e}`);
    error = "An error occurred while loading the html content.";
  }
}
---

<Layout title={appTitle}>

    html ? (
      <Fragment set:html={html} />
    ) : (
      <Alert variant="error" client:only="react">
        {error}
      </Alert>
    )
  }
</Layout>
