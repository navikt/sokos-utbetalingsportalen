---
import { Alert } from "@navikt/ds-react";
import { logger } from "@utils/logger";
import { getOboToken } from "@utils/server/token";

type Props = {
  appIngressUrl?: string;
  appAudience?: string;
};

const { appIngressUrl, appAudience } = Astro.props;
let html = null;
let error = null;

if (!appIngressUrl || !appAudience) {
  logger.error("Missing required props: appIngressUrl or appAudience");
  error = "Configuration error: Missing required microfrontend parameters";
} else {
  try {
    const oboToken = await getOboToken(Astro.locals.token, appAudience);

    const response = await fetch(appIngressUrl, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${oboToken}`,
      },
    });

    if (!response.ok) {
      logger.info(
        {
          url: response.url,
          status: response.status,
          statusText: response.statusText,
        },
        "Failed to fetch microfrontend"
      );
      error = `Failed to load component (${response.status})`;
    } else {
      html = await response.text();
    }
  } catch (e) {
    logger.error(`Fetch from ${appIngressUrl} failed: ${e}`);
    error = "An error occurred while loading the component";
  }
}
---

{html ? <Fragment set:html={html} /> : <Alert variant="error">{error}</Alert>}
